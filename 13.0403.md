# 第十三次课

# 上次课
ip：网络号+主机号
路由器看网络号，到目的后再看主机号
子网：ip不够用，早期A类地址浪费。高位主机号分为网络号，掩码
划分子网：从主机数或网络数入手
地址转换：HOSTS，DNS
ARP，RARP，掌握中文名称
IP包结构

# 6
## 6.1
### 6.1.3 网络层协议与IP协议地址

ip包里没有掩码，怎么办？
总长度：20字节 ~ $2^{16}=65535$字节。受MTU的限制，发送的比这个大怎么办？
ip包分片，用到标识符ID(16bits)，标志FLAG(3bits)，分片偏移量FO(13bits)
每个分片加上片头，FO为$0，\frac{MTU-20}{8},\frac{2MTU-20}{8}$,...
MF最后一个片为0，其他为1，LEN=MTU，例子p33
丢包：路由器不会分片，重组失败

### 6.1.4 传输层协议

只有用户终端里有
报文
端口号：只在终端本地有意义

#### UDP:User Datagram Protocol用户数据报协议
首部8字节p40
- 源端口
- 目的端口
- 长度
- 校验和
- 伪首部（算校验和用）

#### TCP:Transimission Control Protocol传输控制协议
传输层面向连接
可靠交付：差错控制，流量控制，拥塞控制
全双工
面向字节流

socket

**socket复用**：一个主机的某个TCPsocket可以被多个连接共享。本地的应用进程可是同时与多个目的主机的进程分别通信，不会混淆

首部20字节
- 源端口
- 目的端口
- 序号
- **确认序号**
- 首部长
- 保留字
- 控制位
  - UGR
  - ACK
  - PSH
  - RST
  - SYN
  - FIN
- **窗口**
- 校验和
  - 计算时考虑伪首部
- 紧急

**三次握手**
有稍待确认，四步变为三步
1. SYN=1,seq=x
2. SYN=1,ACK=1,seq=y,ack=x+1(希望下一个收到x+1)
3. ACk=1,seq=x+1,ack=y+1

**差错控制**
接收端返回最新的ack
若5未到，67已到，则会多次发ack=5

**重传机制**
- 时间驱动
  - 发送端一定时间没有收到ack则认为报文已丢失
  - 往返时延RTT
  - 更新RTT=(1-$\alpha$)更新前RTT+$\alpha$此次获得的RTT
- 数据驱动
  - 发送端连续收到重复的ack，认为报文已丢失

**流量控制**p58
接收端资源不够用
**端到端动态自适应滑动窗口**

**拥塞控制**
多个窗口：发送端实际发送的窗口受两方控制：接收端流量控制和发送端拥塞控制，取小的那一个
- 慢启动
- 拥塞避免
- 快速重传
- 快速回复
